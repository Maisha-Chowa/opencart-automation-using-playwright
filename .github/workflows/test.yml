name: OpenCart Playwright Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        browser: [chromium, firefox]

    name: Tests (${{ matrix.browser }})

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install Python dependencies
        run: pip install -r requirements.txt

      - name: Install Playwright browsers
        run: playwright install --with-deps ${{ matrix.browser }}

      - name: Start OpenCart with Docker Compose
        run: docker compose up -d

      - name: Wait for OpenCart container to respond
        run: |
          echo "Waiting for OpenCart web server..."
          for i in $(seq 1 60); do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost 2>/dev/null || echo "000")
            if [ "$HTTP_CODE" != "000" ]; then
              echo "Web server responding with HTTP $HTTP_CODE (attempt $i)"
              break
            fi
            echo "Waiting... (attempt $i/60)"
            sleep 5
          done

      - name: Wait for database to accept connections
        run: |
          echo "Waiting for MySQL to be ready..."
          for i in $(seq 1 30); do
            if docker exec opencart-db mysqladmin ping -uroot -popencart_password --silent 2>/dev/null; then
              echo "MySQL is ready (attempt $i)"
              break
            fi
            echo "Waiting for MySQL... (attempt $i/30)"
            sleep 5
          done

      - name: Install OpenCart
        run: |
          echo "=== Container web root ==="
          docker exec opencart-app ls /var/www/html/

          echo ""
          echo "=== Install directory ==="
          docker exec opencart-app ls /var/www/html/install/ 2>/dev/null || echo "(install dir not found)"

          # ── Method 1: CLI installer (most reliable) ──
          echo ""
          echo "=== Attempting CLI installer ==="
          docker exec opencart-app php /var/www/html/install/cli_install.php install \
            --db_driver mysqli \
            --db_hostname database \
            --db_username root \
            --db_password opencart_password \
            --db_database opencart \
            --db_prefix oc_ \
            --db_port 3306 \
            --username admin \
            --password admin123 \
            --email admin@example.com \
            --http_server http://localhost/ 2>&1 \
          && echo "CLI installer succeeded" \
          || {
            echo "CLI installer failed or not available, trying web installer..."

            # ── Method 2: Web installer with cookie jar (preserves session across steps) ──
            echo "Step 1: License..."
            curl -sL -c /tmp/oc_cookies -b /tmp/oc_cookies \
              "http://localhost/install/index.php?route=install/step_1&language=en-gb" -o /dev/null

            echo "Step 2: Pre-installation check..."
            curl -sL -c /tmp/oc_cookies -b /tmp/oc_cookies \
              "http://localhost/install/index.php?route=install/step_2&language=en-gb" -o /dev/null

            echo "Step 3: Database configuration..."
            INSTALL_RESP=$(curl -sL -c /tmp/oc_cookies -b /tmp/oc_cookies \
              -X POST "http://localhost/install/index.php?route=install/step_3&language=en-gb" \
              -d "db_driver=mysqli" \
              -d "db_hostname=database" \
              -d "db_username=root" \
              -d "db_password=opencart_password" \
              -d "db_database=opencart" \
              -d "db_prefix=oc_" \
              -d "db_port=3306" \
              -d "username=admin" \
              -d "password=admin123" \
              -d "email=admin@example.com" \
              -w "\nHTTP_STATUS:%{http_code}")
            echo "Installer response (last 300 chars):"
            echo "$INSTALL_RESP" | tail -c 300
            echo ""

            # Step 4 (finish) — some OC versions need this
            curl -sL -c /tmp/oc_cookies -b /tmp/oc_cookies \
              "http://localhost/install/index.php?route=install/step_4&language=en-gb" -o /dev/null 2>/dev/null || true
          }

          # Remove install directory
          docker exec opencart-app rm -rf /var/www/html/install
          echo ""
          echo "=== Install directory removed ==="

          # ── PHP 8.1 compatibility patches for OpenCart 4.0.0.0 ──

          # 1) Fix cookie path: session.php computes dirname(PHP_SELF).'/'
          #    which yields "//" when PHP_SELF is /index.php.
          docker exec opencart-app sed -i "s|'path'.*dirname.*PHP_SELF.*|'path'     => '/',|" \
            /var/www/html/catalog/controller/startup/session.php

          # 2) Fix TypeError: getCustomerGroup() expects int, gets string
          #    from $this->config->get() which always returns string.
          #    Remove strict int type hint so string '1' is accepted.
          docker exec opencart-app sed -i \
            's/getCustomerGroup(int $customer_group_id)/getCustomerGroup($customer_group_id)/' \
            /var/www/html/catalog/model/account/customer_group.php

          # Restart Apache to clear opcache
          docker exec opencart-app apache2ctl graceful 2>/dev/null || true
          sleep 2

          echo "=== Patches applied ==="
          docker exec opencart-app grep "'path'" /var/www/html/catalog/controller/startup/session.php
          docker exec opencart-app grep "getCustomerGroup" /var/www/html/catalog/model/account/customer_group.php

      - name: Verify installation
        run: |
          # Check storefront loads
          echo "=== Storefront check ==="
          STORE_TITLE=$(curl -sL http://localhost | grep -oP '<title>\K[^<]+' || echo "FAILED")
          echo "Storefront title: $STORE_TITLE"

          # Check a product page loads
          echo "=== Product page check ==="
          PRODUCT_TITLE=$(curl -sL "http://localhost/index.php?route=product/product&language=en-gb&product_id=43" | grep -oP '<title>\K[^<]+' || echo "FAILED")
          echo "Product page title: $PRODUCT_TITLE"

          # Check database has products
          echo "=== Database products ==="
          docker exec opencart-db mysql -uroot -popencart_password opencart -e "
            SELECT product_id, pd.name FROM oc_product p
            JOIN oc_product_description pd USING(product_id)
            WHERE pd.language_id=1 LIMIT 5;
          " 2>/dev/null || echo "Warning: Could not query products"

          # Check the config.php was created
          echo "=== Config file ==="
          docker exec opencart-app test -f /var/www/html/config.php && echo "config.php exists" || echo "config.php MISSING"
          docker exec opencart-app head -5 /var/www/html/config.php 2>/dev/null || true

          # Fail fast if product page returns 404
          if [ "$PRODUCT_TITLE" = "404 Not Found" ] || [ "$PRODUCT_TITLE" = "FAILED" ]; then
            echo ""
            echo "FATAL: OpenCart installation failed — product page not accessible."
            echo "Dumping container logs for debugging:"
            docker logs opencart-app 2>&1 | tail -50
            exit 1
          fi

      - name: Configure OpenCart for testing
        run: |
          docker exec opencart-db mysql -uroot -popencart_password opencart -e "
            DELETE FROM oc_extension WHERE \`type\` = 'captcha';
            DELETE FROM oc_setting WHERE \`code\` LIKE '%captcha%';
            DELETE FROM oc_setting WHERE \`key\` IN ('captcha_page', 'config_captcha');
            UPDATE oc_event SET status = 0 WHERE code LIKE 'mail_%';
          " 2>/dev/null || true

          docker exec opencart-app bash -c "rm -rf /var/www/html/system/storage/cache/*" 2>/dev/null || true
          echo "CAPTCHA disabled, caches cleared."

      - name: Smoke test (click Add to Cart, verify session)
        env:
          BROWSER: ${{ matrix.browser }}
        run: |
          python3 << 'PYEOF'
          import os, sys
          from playwright.sync_api import sync_playwright

          with sync_playwright() as p:
              browser_name = os.environ.get("BROWSER", "chromium")
              browser = getattr(p, browser_name).launch(headless=True)
              ctx = browser.new_context()
              page = ctx.new_page()

              page.goto("http://localhost/index.php?route=product/product&language=en-gb&product_id=43")
              page.wait_for_load_state("networkidle")
              print(f"Product page title: {page.title()}")

              # Verify session cookie path is "/" not "//"
              cookies = ctx.cookies()
              for c in cookies:
                  if "sess" in c["name"].lower():
                      print(f"Cookie: {c['name']} path={c['path']} sameSite={c.get('sameSite')}")
                      assert c["path"] == "/", f"FATAL: cookie path is '{c['path']}' (expected '/') — session.php patch failed"

              # Click Add to Cart (uses jQuery AJAX)
              page.locator("#button-cart").click()
              page.wait_for_selector(".alert-success", timeout=10000)
              print("Add to cart: success alert appeared")

              # Verify session persists to cart page
              page.goto("http://localhost/index.php?route=checkout/cart&language=en-gb")
              page.wait_for_load_state("networkidle")
              names = page.evaluate("""() => Array.from(
                  document.querySelectorAll("#shopping-cart table tbody td:nth-child(2) a")
              ).map(e => e.textContent.trim())""")
              print(f"Cart products: {names}")
              browser.close()

              assert "MacBook" in names, f"Smoke test FAILED: cart empty despite successful add. Products: {names}"
              print("Smoke test PASSED")
          PYEOF

      - name: Run Playwright tests
        run: pytest --browser ${{ matrix.browser }} -m "not admin"
        env:
          BASE_URL: http://localhost/
          ADMIN_URL: http://localhost/admin/
          HEADLESS: "true"

      - name: Upload screenshots on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: screenshots-${{ matrix.browser }}
          path: screenshots/
          retention-days: 14

      - name: Upload traces on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: traces-${{ matrix.browser }}
          path: traces/
          retention-days: 14

      - name: Upload test report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-results-${{ matrix.browser }}
          path: allure-results/
          retention-days: 14

      - name: Stop Docker containers
        if: always()
        run: docker compose down -v

  report:
    name: Publish Allure Report
    needs: test
    if: always()
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download allure results from all browsers
        uses: actions/download-artifact@v4
        with:
          pattern: allure-results-*
          path: allure-results
          merge-multiple: true

      - name: Load previous test report history
        uses: actions/checkout@v4
        continue-on-error: true
        with:
          ref: gh-pages
          path: gh-pages

      - name: Build Allure report with history
        uses: simple-elf/allure-report-action@v1.13
        with:
          gh_pages: gh-pages
          allure_history: allure-history
          allure_results: allure-results

      - name: Publish report to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: allure-history
          force_orphan: true
