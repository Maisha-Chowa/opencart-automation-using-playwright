name: OpenCart Playwright Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        browser: [chromium, firefox, webkit]

    name: Tests (${{ matrix.browser }})

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install Python dependencies
        run: pip install -r requirements.txt

      - name: Install Playwright browsers
        run: playwright install --with-deps ${{ matrix.browser }}

      - name: Start OpenCart with Docker Compose
        run: docker compose up -d

      - name: Wait for OpenCart container to respond
        run: |
          echo "Waiting for OpenCart web server..."
          for i in $(seq 1 60); do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost 2>/dev/null || echo "000")
            if [ "$HTTP_CODE" != "000" ]; then
              echo "Web server responding with HTTP $HTTP_CODE (attempt $i)"
              break
            fi
            echo "Waiting... (attempt $i/60)"
            sleep 5
          done

      - name: Wait for database to accept connections
        run: |
          echo "Waiting for MySQL to be ready..."
          for i in $(seq 1 30); do
            if docker exec opencart-db mysqladmin ping -uroot -popencart_password --silent 2>/dev/null; then
              echo "MySQL is ready (attempt $i)"
              break
            fi
            echo "Waiting for MySQL... (attempt $i/30)"
            sleep 5
          done

      - name: Install OpenCart
        run: |
          echo "=== Container web root ==="
          docker exec opencart-app ls /var/www/html/

          echo ""
          echo "=== Install directory ==="
          docker exec opencart-app ls /var/www/html/install/ 2>/dev/null || echo "(install dir not found)"

          # ── Method 1: CLI installer (most reliable) ──
          echo ""
          echo "=== Attempting CLI installer ==="
          docker exec opencart-app php /var/www/html/install/cli_install.php install \
            --db_driver mysqli \
            --db_hostname database \
            --db_username root \
            --db_password opencart_password \
            --db_database opencart \
            --db_prefix oc_ \
            --db_port 3306 \
            --username admin \
            --password admin123 \
            --email admin@example.com \
            --http_server http://localhost/ 2>&1 \
          && echo "CLI installer succeeded" \
          || {
            echo "CLI installer failed or not available, trying web installer..."

            # ── Method 2: Web installer with cookie jar (preserves session across steps) ──
            echo "Step 1: License..."
            curl -sL -c /tmp/oc_cookies -b /tmp/oc_cookies \
              "http://localhost/install/index.php?route=install/step_1&language=en-gb" -o /dev/null

            echo "Step 2: Pre-installation check..."
            curl -sL -c /tmp/oc_cookies -b /tmp/oc_cookies \
              "http://localhost/install/index.php?route=install/step_2&language=en-gb" -o /dev/null

            echo "Step 3: Database configuration..."
            INSTALL_RESP=$(curl -sL -c /tmp/oc_cookies -b /tmp/oc_cookies \
              -X POST "http://localhost/install/index.php?route=install/step_3&language=en-gb" \
              -d "db_driver=mysqli" \
              -d "db_hostname=database" \
              -d "db_username=root" \
              -d "db_password=opencart_password" \
              -d "db_database=opencart" \
              -d "db_prefix=oc_" \
              -d "db_port=3306" \
              -d "username=admin" \
              -d "password=admin123" \
              -d "email=admin@example.com" \
              -w "\nHTTP_STATUS:%{http_code}")
            echo "Installer response (last 300 chars):"
            echo "$INSTALL_RESP" | tail -c 300
            echo ""

            # Step 4 (finish) — some OC versions need this
            curl -sL -c /tmp/oc_cookies -b /tmp/oc_cookies \
              "http://localhost/install/index.php?route=install/step_4&language=en-gb" -o /dev/null 2>/dev/null || true
          }

          # Remove install directory
          docker exec opencart-app rm -rf /var/www/html/install
          echo ""
          echo "=== Install directory removed ==="

      - name: Verify installation
        run: |
          # Check storefront loads
          echo "=== Storefront check ==="
          STORE_TITLE=$(curl -sL http://localhost | grep -oP '<title>\K[^<]+' || echo "FAILED")
          echo "Storefront title: $STORE_TITLE"

          # Check a product page loads
          echo "=== Product page check ==="
          PRODUCT_TITLE=$(curl -sL "http://localhost/index.php?route=product/product&language=en-gb&product_id=43" | grep -oP '<title>\K[^<]+' || echo "FAILED")
          echo "Product page title: $PRODUCT_TITLE"

          # Check database has products
          echo "=== Database products ==="
          docker exec opencart-db mysql -uroot -popencart_password opencart -e "
            SELECT product_id, pd.name FROM oc_product p
            JOIN oc_product_description pd USING(product_id)
            WHERE pd.language_id=1 LIMIT 5;
          " 2>/dev/null || echo "Warning: Could not query products"

          # Check the config.php was created
          echo "=== Config file ==="
          docker exec opencart-app test -f /var/www/html/config.php && echo "config.php exists" || echo "config.php MISSING"
          docker exec opencart-app head -5 /var/www/html/config.php 2>/dev/null || true

          # Fail fast if product page returns 404
          if [ "$PRODUCT_TITLE" = "404 Not Found" ] || [ "$PRODUCT_TITLE" = "FAILED" ]; then
            echo ""
            echo "FATAL: OpenCart installation failed — product page not accessible."
            echo "Dumping container logs for debugging:"
            docker logs opencart-app 2>&1 | tail -50
            exit 1
          fi

      - name: Configure OpenCart for testing
        run: |
          docker exec opencart-db mysql -uroot -popencart_password opencart -e "
            DELETE FROM oc_extension WHERE \`type\` = 'captcha';
            DELETE FROM oc_setting WHERE \`code\` LIKE '%captcha%';
            DELETE FROM oc_setting WHERE \`key\` IN ('captcha_page', 'config_captcha');
            UPDATE oc_setting SET \`value\` = '' WHERE \`key\` = 'config_mail_engine';
            UPDATE oc_setting SET \`value\` = '' WHERE \`key\` = 'config_mail_smtp_hostname';
          " 2>/dev/null || true

          docker exec opencart-app bash -c "rm -rf /var/www/html/system/storage/cache/*" 2>/dev/null || true
          echo "CAPTCHA disabled, caches cleared."

      - name: Diagnose session handling
        run: |
          python3 << 'PYEOF'
          import json, sys
          from playwright.sync_api import sync_playwright

          def dump_session_cookies(ctx, label):
              cookies = ctx.cookies()
              sc = [c for c in cookies if "sess" in c["name"].lower()]
              for c in sc:
                  print(f"  [{label}] {c['name']}={c['value'][:16]}... "
                        f"domain={c['domain']} path={c['path']} "
                        f"secure={c.get('secure')} sameSite={c.get('sameSite')}")
              if not sc:
                  print(f"  [{label}] NO session cookies found! All cookies: {[c['name'] for c in cookies]}")
              return sc

          with sync_playwright() as p:
              browser = p.chromium.launch(headless=True)
              ctx = browser.new_context()
              page = ctx.new_page()

              # Step 1: Load product page
              page.goto("http://localhost/index.php?route=product/product&language=en-gb&product_id=43")
              page.wait_for_load_state("networkidle")
              title = page.title()
              print(f"Product page title: {title}")
              if "404" in title:
                  browser.close()
                  sys.exit(1)

              sc1 = dump_session_cookies(ctx, "after product page")

              # Step 2: Check jQuery
              jquery = page.evaluate("typeof jQuery")
              print(f"jQuery type: {jquery}")

              # Step 3: Try clicking Add to Cart button (AJAX)
              method = "none"
              try:
                  page.locator("#button-cart").click(timeout=3000)
                  page.wait_for_selector(".alert-success", timeout=10000)
                  alert = page.locator(".alert-success").first.text_content()
                  print(f"Button click WORKED: {alert[:80]}")
                  method = "button_click"
              except Exception as e:
                  print(f"Button click failed: {e}")

              sc2 = dump_session_cookies(ctx, "after add-to-cart")

              # Step 4: Navigate to cart
              page.goto("http://localhost/index.php?route=checkout/cart&language=en-gb")
              page.wait_for_load_state("networkidle")

              sc3 = dump_session_cookies(ctx, "after cart page")

              names = page.evaluate("""() => Array.from(
                  document.querySelectorAll("#shopping-cart table tbody td:nth-child(2) a")
              ).map(e => e.textContent.trim())""")
              print(f"Cart products: {names}")

              # Compare session IDs
              ids = [sc1, sc2, sc3]
              vals = [s[0]["value"] if s else "NONE" for s in ids]
              print(f"Session ID consistency: {vals[0][:12]}... -> {vals[1][:12]}... -> {vals[2][:12]}...")
              if len(set(vals)) > 1:
                  print("WARNING: Session ID changed between requests!")

              browser.close()
              if "MacBook" in names:
                  print(f"Smoke test PASSED (method: {method})")
              else:
                  print(f"Smoke test FAILED (method: {method})")
                  sys.exit(1)
          PYEOF

      - name: Run Playwright tests
        run: pytest --browser ${{ matrix.browser }} -m "not admin"
        env:
          BASE_URL: http://localhost/
          ADMIN_URL: http://localhost/admin/
          HEADLESS: "true"

      - name: Upload screenshots on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: screenshots-${{ matrix.browser }}
          path: screenshots/
          retention-days: 14

      - name: Upload traces on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: traces-${{ matrix.browser }}
          path: traces/
          retention-days: 14

      - name: Upload test report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-results-${{ matrix.browser }}
          path: allure-results/
          retention-days: 14

      - name: Stop Docker containers
        if: always()
        run: docker compose down -v

  report:
    name: Publish Allure Report
    needs: test
    if: always()
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download allure results from all browsers
        uses: actions/download-artifact@v4
        with:
          pattern: allure-results-*
          path: allure-results
          merge-multiple: true

      - name: Load previous test report history
        uses: actions/checkout@v4
        continue-on-error: true
        with:
          ref: gh-pages
          path: gh-pages

      - name: Build Allure report with history
        uses: simple-elf/allure-report-action@v1.9
        with:
          gh_pages: gh-pages
          allure_history: allure-history
          allure_results: allure-results

      - name: Publish report to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: allure-history
