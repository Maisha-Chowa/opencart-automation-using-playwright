name: OpenCart Playwright Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        browser: [chromium, firefox, webkit]

    name: Tests (${{ matrix.browser }})

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install Python dependencies
        run: pip install -r requirements.txt

      - name: Install Playwright browsers
        run: playwright install --with-deps ${{ matrix.browser }}

      - name: Start OpenCart with Docker Compose
        run: docker compose up -d

      - name: Wait for OpenCart to be ready
        run: |
          echo "Waiting for OpenCart to initialize..."
          for i in $(seq 1 60); do
            if curl -s -o /dev/null -w "%{http_code}" http://localhost | grep -q "200\|302"; then
              echo "OpenCart is responding (attempt $i)"
              break
            fi
            echo "Waiting... (attempt $i/60)"
            sleep 5
          done

      - name: Run OpenCart installer
        run: |
          # Complete the OpenCart installation automatically
          curl -sL -X POST "http://localhost/install/index.php?route=install/step_3&language=en-gb" \
            -d "db_driver=mysqli" \
            -d "db_hostname=database" \
            -d "db_username=root" \
            -d "db_password=opencart_password" \
            -d "db_database=opencart" \
            -d "db_prefix=oc_" \
            -d "db_port=3306" \
            -d "username=admin" \
            -d "password=admin123" \
            -d "email=admin@example.com" \
            -o /dev/null -w "Install HTTP status: %{http_code}\n"

          # Remove the install directory
          docker exec opencart-app rm -rf /var/www/html/install

          # Verify storefront is accessible
          echo "Verifying storefront..."
          curl -sL http://localhost | grep -q "<title>" && echo "Storefront is ready!" || echo "Warning: Storefront may not be ready"

      - name: Configure OpenCart for testing
        run: |
          # Disable CAPTCHA on registration/login/contact pages so form tests work
          docker exec opencart-db mysql -uroot -popencart_password opencart -e "
            DELETE FROM oc_setting WHERE \`key\` IN ('captcha_page', 'config_captcha');
            UPDATE oc_setting SET \`value\` = '' WHERE \`key\` = 'config_mail_engine';
          " 2>/dev/null || true

          # Verify DB has products (sanity check)
          docker exec opencart-db mysql -uroot -popencart_password opencart -e "
            SELECT product_id, pd.name FROM oc_product p
            JOIN oc_product_description pd USING(product_id)
            WHERE pd.language_id=1 LIMIT 5;
          " 2>/dev/null || echo "Warning: Could not verify products"

      - name: Run Playwright tests
        run: pytest --browser ${{ matrix.browser }} -m "not admin"
        env:
          BASE_URL: http://localhost/
          ADMIN_URL: http://localhost/admin/
          HEADLESS: "true"

      - name: Upload screenshots on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: screenshots-${{ matrix.browser }}
          path: screenshots/
          retention-days: 14

      - name: Upload traces on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: traces-${{ matrix.browser }}
          path: traces/
          retention-days: 14

      - name: Upload test report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-results-${{ matrix.browser }}
          path: allure-results/
          retention-days: 14

      - name: Stop Docker containers
        if: always()
        run: docker compose down -v

  report:
    name: Publish Allure Report
    needs: test
    if: always()
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download allure results from all browsers
        uses: actions/download-artifact@v4
        with:
          pattern: allure-results-*
          path: allure-results
          merge-multiple: true

      - name: Load previous test report history
        uses: actions/checkout@v4
        continue-on-error: true
        with:
          ref: gh-pages
          path: gh-pages

      - name: Build Allure report with history
        uses: simple-elf/allure-report-action@v1.9
        with:
          gh_pages: gh-pages
          allure_history: allure-history
          allure_results: allure-results

      - name: Publish report to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: allure-history
